/*!
 * World JS
 * Version 3.0.0
 *
 * https://github.com/anvoz/world-js
 * Copyright (c) 2013-2014 An Vo - anvo4888@gmail.com
 * Licensed under MIT (http://www.opensource.org/licenses/mit-license.php)
 */
!function(a,b){"use strict";var c=a.document,d=function(){return a.requestAnimationFrame||a.webkitRequestAnimationFrame||a.mozRequestAnimationFrame||a.oRequestAnimationFrame||a.msRequestAnimationFrame||function(b){a.setTimeout(function(){b(+new Date)},1e3/60)}}(),e=a.WorldJS=function(){var a=this;a.running=!1,a.stopCallback=function(){},a.width=640,a.height=360,a.padding=10,a.canvas={wrapper:!1,context:!1},a.sprite={src:"images/icons.png",image:!1},a.displayMode="full",a.totalSeeds=0,a.nextSeedId=1,a.maxSafeSeedsForDisplay=3e4,a.tickPerYear=60,a.speed=1,a.tickMod=0,a.distributedTicks=[];for(var b=0;b<a.tickPerYear-1;b++)a.distributedTicks.push(0);a.lastTickTime=0,a.fps=0,a.tile=new e.Tile(a),a.event=new e.Event(a)};e.prototype.init=function(a){var b=this,d=c.createElement("canvas"),e=c.getElementById(a),f=e.clientWidth||b.width,g=e.clientHeight||b.height;b.canvas.wrapper=e,b.width=d.width=f,b.height=d.height=g,e.appendChild(d),b.canvas.context=d.getContext("2d");var h=new Image;return h.src=b.sprite.src,b.sprite.image=h,b.tile.init(f,g),b},e.prototype.addSeed=function(a,c){c=c||{};var d=this,e=new a(c);d.totalSeeds++,e.world=d,e.id=d.nextSeedId++,e.age=c.age||0,e.tickCount=e.age>0?e.age*d.tickPerYear:e.tickCount;var f=d.getTickIndex();d.distributedTicks[f]++,e.tickIndex=f,e.tickMod=d.tickMod,e.tickCount+=(d.tickMod+e.tickCount+e.tickIndex)%e.actionInterval,e.stepCount=e.tickCount,e.moveUntilStep=e.moveUntilStep||e.tickCount+d.random(2,10)*e.jumpInterval;var g=d.getRandomPosition(e);return e.x=g.x,e.y=g.y,e.tileIndex=d.tile.getIndex(e),d.tile.set(e),d.event.trigger("seedAdded",{seed:e,mother:c.mother||b}),e},e.prototype.getTickIndex=function(){for(var a=this,b=a.distributedTicks,c=0,d=b[c],e=0,f=b.length;f>e;e++)b[e]<d&&(c=e,d=b[e]);return c},e.prototype.getRandomPosition=function(a,b){b=b||!1;var c=this,d=a.x===!1||b?c.random(c.padding,c.width-a.icon.width-c.padding):a.x,e=a.y===!1||b?c.random(c.padding,c.height-a.icon.height-c.padding):a.y;return{x:d,y:e}},e.prototype.removeSeed=function(a){var b=this;return b.totalSeeds--,b.event.trigger("seedRemoved",{seed:a}),a.relationSeed!==!1&&(a.relationSeed.relationSeed=!1,a.relationSeed=!1),b.tile.rem(a),b.distributedTicks[a.tickIndex]--,b},e.prototype.addSeeds=function(a,b){b=b||{};for(var c=this,d="undefined"!=typeof b.types?b.types:[c.Seed],e="undefined"!=typeof b.minAge?b.minAge:15,f="undefined"!=typeof b.maxAge?b.maxAge:20,g=0;a>g;g++){var h=c.random(e,f),i={x:!1,y:!1,age:h};if("undefined"!=typeof b.fromBorder){var j=["top","bottom","left","right"],k="random"===b.fromBorder?j[c.random(0,3)]:b.fromBorder;switch(k){case"top":i.y=c.random(0,c.padding);break;case"bottom":i.y=c.random(c.height-c.padding-1,c.height-1);break;case"left":i.x=c.random(0,c.padding);break;case"right":i.x=c.random(c.width-c.padding-1,c.width-1)}}c.addSeed(d[g%d.length],i)}return c},e.prototype.run=function(a){var b=this,c=b.canvas.context,e=b.sprite.image;b.tickMod=++b.tickMod%b.tickPerYear;var f=0===b.tickMod,g=b.totalSeeds<=b.maxSafeSeedsForDisplay||f;g&&c.clearRect(0,0,b.width,b.height);for(var h=b.tile.list,i=b.tile.maxDisplayedSeeds,j=b.speed,k=0,l=h.length;l>k;k++)for(var m=h[k],n=0,o=0,p=m.length;p>o;o++)if(m[o]){var q=m[o],r=q.tileIndex;if(q.tickMod==b.tickMod)continue;if(q.tickMod=b.tickMod,f&&q.age++,g&&i>n){switch(b.displayMode){case"full":q.draw(c,e);break;case"dot":q.draw(c,!1);break;case"none":}n++}q.tick(j);var s=b.tile.getIndex(q);s!==r&&(b.tile.rem(q),q.tileIndex=s,b.tile.set(q))}return f&&(b.event.trigger("yearPassed"),0===b.totalSeeds)?void(b.running=!1):(b.running?(b.fps=1e3/(a-b.lastTickTime),b.lastTickTime=a,d(function(){b.run.call(b)})):(b.stopCallback.call(b),b.stopCallback=function(){}),b)},e.prototype.start=function(){var a=this;return a.running=!0,a.run(),a},e.prototype.stop=function(a){var b=this;return b.running=!1,"function"==typeof a&&(b.stopCallback=a),b},e.prototype.random=function(a,b){return Math.floor(Math.random()*(b-a+1)+a)}}(window),function(a){"use strict";var b,c=a.WorldJS;b=c.Tile=function(a){var b=this;b.world=a,b.list=[],b.availableArrayIndexes=[],b.size=20,b.maxDisplayedSeeds=7,b.totalTiles=!1,b.tilesPerRow=!1,b.tilesPerCol=!1},b.prototype.init=function(a,b){var c=this,d=c.size,e=Math.ceil(b/d),f=Math.ceil(a/d),g=e*f;c.tilesPerRow=e,c.tilesPerCol=f,c.totalTiles=g;for(var h=c.list,i=c.availableArrayIndexes,j=0;g>j;j++)h.push([]),i.push([])},b.prototype.getIndex=function(a){var b=this.size,c=Math.floor(a.x/b),d=Math.floor(a.y/b);return c+d*this.tilesPerCol},b.prototype.set=function(a){var b=this,c=a.tileIndex,d=b.list[c],e=b.availableArrayIndexes[c];e.length>0?(a.tileArrayIndex=e.pop(),d[a.tileArrayIndex]=a):(a.tileArrayIndex=d.length,d.push(a))},b.prototype.rem=function(a){var b=this,c=a.tileIndex,d=a.tileArrayIndex;b.list[c][d]=!1,b.availableArrayIndexes[c].push(d)}}(window),function(a){"use strict";var b,c=a.WorldJS;b=c.Event=function(a){var b=this;b.world=a,b.list={yearPassed:{},seedAdded:{},seedRemoved:{}}},b.prototype.add=function(a,b,c){this.list[a][b]=c},b.prototype.remove=function(a,b){delete this.list[a][b]},b.prototype.trigger=function(a,b){var c=this,d=c.world,e=c.list[a];for(var f in e)e.hasOwnProperty(f)&&e[f].call(d,b)}}(window),function(a){"use strict";var b,c=a.WorldJS;b=c.prototype.Seed=function(a){var b=this;b.world=!1,b.id=!1,b.tileIndex=!1,b.tickIndex=!1,b.tickMod=!1,b.age=a.age||0,b.x="undefined"==typeof a.x?!1:a.x,b.y="undefined"==typeof a.y?!1:a.y,b.icon=a.icon||{width:1,height:1},b.carrying=a.carrying||!1,b.relationSeed=a.relationSeed||!1,b.tickCount=a.tickCount||0,b.actionInterval=a.actionInterval||30,b.stepCount=b.tickCount,b.jumpInterval=20,b.moveUntilStep=a.moveUntilStep||0,b.ageToMoveAgain=0,b.isMoving=!1,b.moveTo=a.moveTo||!1},b.prototype.draw=function(a,b){var c=this;if(b===!1||1===c.icon.width){var d=b!==!1?c.icon.width:1,e=b!==!1?c.icon.height:1;a.fillRect(c.x,c.y,d,e)}else{var f=c.age<=c.maxChildAge?c.icon.child:c.icon,g=c.jumpInterval,h=10,i=c.stepCount%g,j=h>i?i+1:h-i%h-1;if(a.drawImage(b,f.x,f.y,f.width,f.height,c.x,c.y-j,f.width,f.height),c.carrying!==!1&&"none"!==c.carrying){var k=c.carrying;a.drawImage(b,k.x,k.y,k.width,k.height,c.x+k.dx,c.y-j+k.dy,k.width,k.height)}}},b.prototype.getCarryingItem=function(a,b){var c=this,d=c.world;if("undefined"!=typeof d.items){var e=d.items,f=[];for(var g in e){var h=e[g];h.enabled===!0&&h.who===a&&h.when===b&&f.push(h.icon)}var i=f.length;if(1===i)return f[0];if(i>1)return f[d.random(0,i-1)]}return!1},b.prototype.move=function(a,b){var c=this,d=c.world,e=d.random;if(c.isMoving=!0,b)b.call(c);else if(c.stepCount>=c.moveUntilStep){if(0===c.ageToMoveAgain||c.ageToMoveAgain>c.age)return 0===c.ageToMoveAgain&&(c.ageToMoveAgain=c.age+e(2,c.age),c.carrying=!1),void(c.isMoving=!1);c.ageToMoveAgain=0,c.moveUntilStep=c.stepCount+e(2,10)*c.jumpInterval,c.carrying=!1}(c.moveTo===!1||c.moveTo.x===c.x&&c.moveTo.y===c.y)&&(c.moveTo=d.getRandomPosition(c,!0)),c.stepCount++,c.x<c.moveTo.x?c.x=Math.min(c.x+a,c.moveTo.x):c.x>c.moveTo.x&&(c.x=Math.max(c.x-a,0)),c.y<c.moveTo.y?c.y=Math.min(c.y+a,c.moveTo.y):c.y>c.moveTo.y&&(c.y=Math.max(c.y-a,0))},b.prototype.seek=function(a){var b=this,c=b.world.tile,d=[[0,0],[-1,0],[1,0],[0,-1],[0,1],[-1,-1],[-1,1],[1,-1],[1,1]];a||(a=function(a){return a.id!=b.id});for(var e=c.tilesPerRow,f=c.tilesPerCol,g=0,h=d.length;h>g;g++){var i;if(0===g)i=b.tileIndex;else{var j=b.tileIndex%e+d[g][0],k=Math.floor(b.tileIndex/e)+d[g][1];if(!(j>=0&&e>j&&k>=0&&f>k))continue;i=j+k*e}for(var l=c.list[i],m=0,n=l.length;n>m;m++)if(l[m]&&b.id!=l[m].id){var o=l[m];if(a.call(b,o))return o}}return!1},b.prototype.tick=function(a){var b=this;b.tickCount++,b.move(a)},b.prototype.getChance=function(a){for(var b=this,c=b.chances[a],d=b.age,e=0,f=0,g=0,h=0;c[e]&&d>=c[e].range[0];){var i=c[e];f=i.range[0],g=i.from,h=(i.to-i.from)/(i.range[1]-i.range[0]),e++}return g+(d-f)*h}}(window),function(a){"use strict";var b,c=a.WorldJS,d=c.prototype.Seed;b=c.prototype.Male=function(a){var b=this;a.icon={x:0,y:0,width:13,height:20,child:{x:26,y:0,width:11,height:10}},d.call(b,a),b.maxChildAge=15,b.chances=a.chances||{death:[{range:[1,20],from:.02,to:.01},{range:[20,60],from:.01,to:.02},{range:[60,80],from:.02,to:.05},{range:[80,100],from:.05,to:.9}],marriage:[{range:[15,30],from:.1,to:.5},{range:[30,50],from:.5,to:.1},{range:[50,80],from:.1,to:.01}]}},b.prototype=Object.create(d.prototype),b.prototype.contructor=b,b.prototype.tick=function(a){var b=this,c=b.world;b.tickCount++;var d=b.actionInterval/a;if(b.tickCount%d===d-1){var e=b.getChance("death");if(e>0&&Math.random()<e)return void c.removeSeed(b);if(b.relationSeed===!1&&b.age>=b.chances.marriage[0].range[0]){var f=b.getChance("marriage");if(f>0){var g=Math.random();if(f>g){var h=b.seek(function(a){var b=this,c=b.world;return a instanceof c.Female&&a.relationSeed===!1&&a.age>=a.chances.childbirth[0].range[0]&&(a.age<=b.age||g*Math.ceil((a.age-b.age)/10)<f)});h!==!1&&(b.relationSeed=h,h.relationSeed=b,"undefined"==typeof h.totalChildren&&(h.totalChildren=0),h.ageLastBear=h.age+1,b.carrying=!1,h.carrying=!1)}}}}if(b.relationSeed!==!1){if(b.x===Math.max(0,b.relationSeed.x-10)&&b.y===b.relationSeed.y)return;b.move(a,function(){var a=this,b=a.relationSeed;a.moveTo.x=Math.max(a.world.padding,b.x-10),a.moveTo.y=b.y})}else b.move(a,!1);if(b.carrying===!1&&"undefined"!=typeof c.items)if(Math.random()<.2){if(b.age>b.maxChildAge){var i=b.relationSeed===!1?"man":"husband",j=b.isMoving?"moving":"standing";b.carrying=b.getCarryingItem(i,j)}}else b.carrying="none"}}(window),function(a,b){"use strict";var c,d=a.WorldJS,e=d.prototype.Seed;c=d.prototype.Female=function(a){var c=this;a.icon={x:13,y:0,width:13,height:20,child:{x:26,y:10,width:11,height:10}},e.call(c,a),c.maxChildAge=15,c.totalChildren=b,c.ageLastBear=0,c.chances=a.chances||{death:[{range:[1,25],from:.02,to:.01},{range:[25,65],from:.01,to:.02},{range:[65,85],from:.02,to:.05},{range:[85,105],from:.05,to:.9}],childbirth:[{range:[15,25],from:.1,to:.25},{range:[25,50],from:.25,to:.1},{range:[50,70],from:.1,to:.001}]}},c.prototype=Object.create(e.prototype),c.prototype.contructor=c,c.prototype.tick=function(a){var b=this,c=b.world;b.tickCount++;var d=b.actionInterval/a;if(b.tickCount%d===d-1){var e=b.age,f=b.getChance("death");if(f>0&&Math.random()<f)return void c.removeSeed(b);if(b.relationSeed!==!1&&e>=b.chances.childbirth[0].range[0]&&e>b.ageLastBear){var g=b.getChance("childbirth");if(g>0&&Math.random()<g){b.ageLastBear=e+1,b.totalChildren++;var h={x:b.x,y:Math.min(c.height-1-c.padding,b.y+Math.floor(b.icon.height/2)),mother:b};Math.random()<.5?c.addSeed(c.Male,h):c.addSeed(c.Female,h)}}}if(b.move(a,!1),b.carrying===!1&&"undefined"!=typeof c.items)if(Math.random()<.2){if(b.age>b.maxChildAge){var i=b.relationSeed===!1?"woman":"wife",j=b.isMoving?"moving":"standing";b.carrying=b.getCarryingItem(i,j)}}else b.carrying="none"}}(window);